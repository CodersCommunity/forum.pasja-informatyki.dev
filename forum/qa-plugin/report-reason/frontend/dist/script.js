!function(t){var e={};function r(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=e,r.d=function(t,e,o){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(o,n,function(e){return t[e]}.bind(null,n));return o},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="../qa-plugin/report-reason/frontend/dist/",r(r.s=9)}([function(t,e,r){var o=r(4),n=r(5),a=r(6),s=r(8);t.exports=function(t,e){return o(t)||n(t,e)||a(t,e)||s()}},function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function r(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}t.exports=function(t,e,o){return e&&r(t.prototype,e),o&&r(t,o),t}},function(t,e){t.exports=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}},function(t,e){t.exports=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var r=[],o=!0,n=!1,a=void 0;try{for(var s,i=t[Symbol.iterator]();!(o=(s=i.next()).done)&&(r.push(s.value),!e||r.length!==e);o=!0);}catch(t){n=!0,a=t}finally{try{o||null==i.return||i.return()}finally{if(n)throw a}}return r}}},function(t,e,r){var o=r(7);t.exports=function(t,e){if(t){if("string"==typeof t)return o(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?o(t,e):void 0}}},function(t,e){t.exports=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=new Array(e);r<e;r++)o[r]=t[r];return o}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(t,e,r){"use strict";r.r(e);var o=r(0),n=r.n(o),a=r(1),s=r.n(a),i=r(2),u=r.n(i),p=function(){function t(){s()(this,t),this.flagButtonDOM=null,this.regex={question:/q_doflag/,answer:/^a(\d+)_doflag/,comment:/^c(\d+)_doflag/,doComment:/^a(\d+)_docomment/}}return u()(t,[{key:"onClick",value:function(t,e){e.target.name&&e.target.name.endsWith("doflag")&&(e.preventDefault(),e.stopPropagation(),this.flagButtonDOM=e.target,t())}},{key:"getPostIdFromInputName",value:function(t,e){var r=e.match(this.regex[t]);return n()(r,2)[1]}},{key:"recognizeInputKindByName",value:function(t){var e=Object.entries(this.regex).find((function(e){var r=n()(e,2);r[0];return r[1].test(t)}));return n()(e,1)[0]}},{key:"collectForumPostMetaData",value:function(){var t=this.recognizeInputKindByName(this.flagButtonDOM.name),e={questionId:this.flagButtonDOM.form.getAttribute("action").split("/")[1],postType:t.slice(0,1)};return e.postId=this.getPostIdFromInputName(t,this.flagButtonDOM.name)||e.questionId,e}},{key:"getFlagButtonDOM",value:function(){return this.flagButtonDOM}},{key:"getPostParentId",value:function(t,e){if("c"!==t)return null;var r=e.closest('[id*="_list"]');return r?r.id.match(/\d+/)[0]:null}},{key:"swapFlagBtn",value:function(t,e){var r=document.createElement("div");r.innerHTML=e;var o=r.removeChild(r.firstElementChild);t.parentNode.replaceChild(o,t)}},{key:"updateCurrentPostFlags",value:function(t,e){var r=this.prepareFlagsUpdate(t,e),o=r.flags,n=r.flagsAlreadyExist,a=r.flagsParent;return o?(n?a.parentNode.replaceChild(o,a):a.appendChild(o),!0):(console.error("Report reason response does not have new flags: ",t),!1)}},{key:"prepareFlagsUpdate",value:function(t,e){var r=e.postType,o=e.postId,n="q"===r?"view":"item",a=".qa-".concat(r,"-").concat(n,"-"),s="#".concat(r).concat(o," ").concat(a),i=document.querySelector("".concat(s,"flags"));return{flags:(new DOMParser).parseFromString(t,"text/html").querySelector("".concat(a,"flags")),flagsAlreadyExist:!!i,flagsParent:i||document.querySelector("".concat(s,"meta"))}}}]),t}(),c=r(3),l=r.n(c);var d=function(t){return new Promise((function(e,r){var o=setTimeout((function(){r("AJAX_TIMEOUT")}),5e3);fetch("/report-flag",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((function(t){return clearTimeout(o),t.ok||r(t.text()),t.json().then(e)})).catch(r)}))};function f(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,o)}return r}function R(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?f(Object(r),!0).forEach((function(e){l()(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var h=FLAG_REASONS_METADATA,m=h.NOTICE_LENGTH,v=h.POPUP_LABELS,g=h.ERROR_CODES,y=function(){function t(){s()(this,t),this.buildForm(),this.initReportReasonValidationErrorDOM(),this.initReasonList(),this.initTextArea(),this.initFormInvalidityListenerAPI(),this.requestIntegerKeys=["postId","questionId","reasonId"],this.sendButton=null}return u()(t,[{key:"buildForm",value:function(){var t=document.createElement("form");t.method="post",t.classList.add("report-reason-popup__form"),t.innerHTML=this.getFormHTML(this.getReasonListHTML()),this.formDOM=t}},{key:"getReasonListHTML",value:function(){var t=this;return Object.entries(FLAG_REASONS_METADATA.REASON_LIST).reduce((function(e,r,o,a){var s=n()(r,2),i=s[0],u=s[1],p=o===a.length-1,c=p&&t.getTextAreaHTML();return e+t.getListItemsHTML({reasonKey:i,reasonValue:u,index:o,isLast:p,textAreaDOM:c})}),"")}},{key:"initReasonList",value:function(){var t=this,e=this.formDOM.querySelector("#reportReasonList");e.addEventListener("change",(function(r){var o=r.target;t.reportReasonValidationErrorDOM.classList.remove("display-block");var n=e.children[e.children.length-1].contains(o);t.formDOM.elements.customReportReason.parentNode.classList.toggle("display-none",!n),t.formDOM.elements.customReportReason.required=n,t.formDOM.elements.sendReportReason.disabled=!1,n&&t.formDOM.elements.customReportReason.focus()}))}},{key:"initReportReasonValidationErrorDOM",value:function(){this.reportReasonValidationErrorDOM=this.formDOM.querySelector("#reportReasonValidationError")}},{key:"initTextArea",value:function(){var t=this;this.customReportReasonCharCounter=this.formDOM.querySelector("#customReportReasonCharCounter"),this.formDOM.elements.customReportReason.addEventListener("input",(function(e){var r=e.target;t.formDOM.elements.sendReportReason.disabled=!1,t.reportReasonValidationErrorDOM.classList.remove("display-block"),t.customReportReasonCharCounter.textContent=m-r.value.length}))}},{key:"initFormInvalidityListenerAPI",value:function(){var t=this;this.formInvalidityListenerAPI={_handler:function(t){t.preventDefault()},attach:function(){t.formDOM.addEventListener("invalid",t.formInvalidityListenerAPI._handler,!0)},detach:function(){t.formDOM.removeEventListener("invalid",t.formInvalidityListenerAPI._handler,!0)}}}},{key:"resetCustomReportReasonCharCounter",value:function(){this.customReportReasonCharCounter.textContent=m}},{key:"getTextAreaHTML",value:function(){return'\n\t\t\t<div id="customReportReasonWrapper" class="display-none">\n\t\t\t\t<small class="report-reason-popup__custom-report-reason-char-counter-wrapper">\n\t\t\t\t\t'.concat(v.CHAR_COUNTER_INFO,'\n\t\t\t\t\t<output id="customReportReasonCharCounter">').concat(m,'</output>\n\t\t\t\t</small>\n\t\t\t\t<textarea id="customReportReason"\n\t\t\t\t\tclass="report-reason-popup__custom-report-reason"\n\t\t\t\t\tname="reportReason"\n\t\t\t\t\tmaxlength="').concat(m,'"\n\t\t\t\t\trows="3"\n\t\t\t\t\tcols="47"></textarea>\n\t\t\t</div>')}},{key:"getListItemsHTML",value:function(t){var e=t.reasonKey,r=t.reasonValue,o=t.index,n=t.isLast,a=t.textAreaDOM;return'\n\t\t\t<li>\n\t\t\t\t<label for="'.concat(e,'">\n\t\t\t\t\t<input id="').concat(e,'" \n\t\t\t\t\t\t\ttype="radio" \n\t\t\t\t\t\t\tvalue="').concat(o,'" \n\t\t\t\t\t\t\tname="reportReason"\n\t\t\t\t\t\t\trequired>\n\t\t\t\t\t').concat(r,"\n\t\t\t\t</label>\n\t\t\t\t").concat(n?a:"","\n\t\t\t</li>")}},{key:"getFormHTML",value:function(t){return"\n\t\t\t<fieldset>\n\t\t\t\t<legend>".concat(v.HEADER,'</legend>\n\t\t\t\t<ul id="reportReasonList" class="report-reason-popup__list">').concat(t,'</ul>\n\t\n\t\t\t\t<span id="reportReasonValidationError" class="report-reason-popup__validation-error">').concat(g.GENERIC_ERROR,'</span>\n\t\n\t\t\t\t<button id="cancelReportReason"\n\t\t\t\t\ttype="button"\n\t\t\t\t\tclass="report-reason-popup__button report-reason-popup__button--cancel">').concat(v.CANCEL,'</button>\n\t\t\t\t<button id="sendReportReason"\n\t\t\t\t\ttype="submit"\n\t\t\t\t\tclass="report-reason-popup__button report-reason-popup__button--save">').concat(v.SEND,"</button>\n\t\t\t</fieldset>")}},{key:"getFormDOM",value:function(){return this.formDOM}},{key:"getReportReasonValidationErrorDOM",value:function(){return this.reportReasonValidationErrorDOM}},{key:"initButtons",value:function(t){var e=this,r=t.collectForumPostMetaData,o=t.hideReportReasonPopup,n=t.onAjaxSuccess,a=t.showFeedbackPopup;this.formDOM.elements.cancelReportReason.addEventListener("click",o),this.formDOM.elements.sendReportReason.addEventListener("click",(function(t){e.handleReportResult(e.submitForm(t,r()),n,a)}))}},{key:"prepareFormData",value:function(t){var e=new FormData(this.formDOM).getAll("reportReason"),r=n()(e,2),o=r[0],a=r[1];return R(R({},t),{},{reasonId:o,notice:a,reportType:"addFlag"})}},{key:"normalizeIntegerProps",value:function(t){var e=this;return Object.entries(t).reduce((function(t,r){var o=n()(r,2),a=o[0],s=o[1];return e.requestIntegerKeys.includes(a)&&(t[a]=parseInt(s)),t}),t)}},{key:"submitForm",value:function(t,e){t.preventDefault(),this.sendButton=t.target,this.sendButton.disabled=!0;var r=this.validateForm();if(r)return Promise.reject({formValidationErrorCode:r});var o=this.prepareFormData(e);return this.toggleSendWaitingState(this.sendButton,!0),d(this.normalizeIntegerProps(o)).then((function(t){return R(R({},t),{},{formData:o})}))}},{key:"handleReportResult",value:function(t,e,r){var o=this;t.then((function(t){if(!t.newFlags)return Promise.reject(t);o.sendButton.disabled=!1,e(t)})).catch((function(t){t.formValidationErrorCode?o.handleReportReasonError(t):o.handleReportReasonError(t,r)})).finally((function(){o.toggleSendWaitingState(o.sendButton,!1)}))}},{key:"handleReportReasonError",value:function(t,e){var r=t.formValidationErrorCode||t.processingFlagReasonError||t,o=this.getErrorContent(r);"function"==typeof e?e(o):this.onFormSubmissionError(o),console.error("Report reason rejected: ",t," /errorContent: ",o)}},{key:"validateForm",value:function(){return this.formDOM.reportValidity()?"":this.formDOM.elements.customReportReason.validity.valid?"NO_REASON_CHECKED":"CUSTOM_REASON_EMPTY"}},{key:"getErrorContent",value:function(t){if(!t||t instanceof Error)return g.GENERIC_ERROR;if(t.includes(":")){var e=t.split(":"),r=n()(e,2),o=r[0],a=r[1];return g[o]?g[o]+a:g.GENERIC_ERROR}return g[t]}},{key:"onFormSubmissionError",value:function(t){var e=this;this.reportReasonValidationErrorDOM.innerHTML=t,this.reportReasonValidationErrorDOM.classList.add("display-block","report-reason-popup__validation-error--blink"),setTimeout((function(){e.reportReasonValidationErrorDOM.classList.remove("report-reason-popup__validation-error--blink")}),1750)}},{key:"toggleSendWaitingState",value:function(t,e){e?window.qa_show_waiting_after(t,!0):window.qa_hide_waiting(t)}}]),t}();var O=function(t){var e=t.postType,r=t.questionId,o=t.postId,n=t.parentId,a=e+o,s="";switch(e){case"q":s="qa_show_waiting_after(this, false)",a=e;break;case"a":s="return qa_answer_click(".concat(o,", ").concat(r,", this);");break;case"c":s="return qa_comment_click(".concat(o,", ").concat(r,", ").concat(n,", this);");break;default:throw new Error("Unrecognized postType: ".concat(e," for questionId: ").concat(r," and postId: ").concat(o))}return'\n\t\t<input name="'.concat(a).concat("_dounflag",'" \n\t\t\tonclick="').concat(s,'"\n\t\t\tvalue="').concat("wycofaj zgłoszenie",'"\n\t\t\ttitle="').concat("Wycofaj zgłoszenie tej treści",'"\n\t\t\ttype="').concat("submit",'" \n\t\t\tclass="').concat("qa-form-light-button qa-form-light-button-unflag",'">\n\t')},b=FLAG_REASONS_METADATA,P=b.POPUP_LABELS,M=b.ERROR_CODES,D=function(){function t(e){var r=e.getFlagButtonDOM,o=e.formInvalidityListenerAPI,n=e.getFormDOM,a=e.getPostParentId,i=e.swapFlagBtn,u=e.updateCurrentPostFlags,p=e.getReportReasonValidationErrorDOM,c=e.resetCustomReportReasonCharCounter;s()(this,t),this.getFlagButtonDOM=r,this.formInvalidityListenerAPI=o,this.getFormDOM=n,this.getPostParentId=a,this.swapFlagBtn=i,this.updateCurrentPostFlags=u,this.getReportReasonValidationErrorDOM=p,this.resetCustomReportReasonCharCounter=c,this.reportReasonPopupDOMWrapper=null,this.reportReasonPopupDOMReferences=null,this.initReportReasonPopupDOMWrapper(),this.initPopupContainer(),this.initPopupDOMReferences(),this.initOffClickHandler(),this.initSuccessPopupCloseBtn()}return u()(t,[{key:"initOffClickHandler",value:function(){var t=this;this.reportReasonPopupDOMWrapper.addEventListener("click",(function(e){!e.composedPath().some((function(t){return"reportReasonPopup"===t.id||"reportReasonRequestFeedback"===t.id}))&&t.hideReportReasonPopup()}))}},{key:"initPopupContainer",value:function(){document.querySelector(".qa-body-wrapper").appendChild(this.reportReasonPopupDOMWrapper)}},{key:"initReportReasonPopupDOMWrapper",value:function(){var t=document.createElement("div");t.classList.add("report-reason-wrapper"),t.innerHTML=this.getPopupWrapperHTML();var e=t.querySelector("#replaceableForm");e.parentNode.replaceChild(this.getFormDOM(),e),this.reportReasonPopupDOMWrapper=t}},{key:"initPopupDOMReferences",value:function(){this.reportReasonPopupDOMReferences={reportReasonPopup:this.reportReasonPopupDOMWrapper.querySelector("#reportReasonPopup"),customReportReason:this.reportReasonPopupDOMWrapper.querySelector("#customReportReason"),reportReasonRequestFeedback:this.reportReasonPopupDOMWrapper.querySelector("#reportReasonRequestFeedback"),reportReasonRequestInfo:this.reportReasonPopupDOMWrapper.querySelector("#reportReasonRequestInfo"),closeReportReasonRequestFeedback:this.reportReasonPopupDOMWrapper.querySelector("#closeReportReasonRequestFeedback")}}},{key:"getPopupWrapperHTML",value:function(){return'\n\t\t\t<div id="reportReasonPopup" class="report-reason-popup">\n\t\t\t\t<form id="replaceableForm"></form>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div id="reportReasonRequestFeedback" class="report-reason-popup__request-feedback">\n\t\t\t\t<div id="reportReasonRequestInfo" class="report-reason-popup__request-feedback-info"></div>\n\t\t\t\t<button id="closeReportReasonRequestFeedback"\n\t\t\t\t\tclass="report-reason-popup__button report-reason-popup__button--close"\n\t\t\t\t\ttype="button">'.concat(P.CLOSE,"</button>\n\t\t\t</div>\n\t\t")}},{key:"showReportReasonPopup",value:function(){this.formInvalidityListenerAPI.attach(),this.reportReasonPopupDOMWrapper.classList.add("display-block"),this.getFormDOM().elements.reportReason[0].focus()}},{key:"hideReportReasonPopup",value:function(){this.formInvalidityListenerAPI.detach(),this.reportReasonPopupDOMReferences.reportReasonRequestFeedback.classList.remove("display-block"),this.reportReasonPopupDOMWrapper.classList.remove("display-block"),this.reportReasonPopupDOMReferences.customReportReason.parentNode.classList.add("display-none"),this.reportReasonPopupDOMReferences.reportReasonPopup.classList.remove("display-none"),this.getReportReasonValidationErrorDOM().classList.remove("display-block");var t=this.getFormDOM();t.reset(),t.elements.customReportReason.required=!1,t.elements.sendReportReason.disabled=!1,this.resetCustomReportReasonCharCounter(),this.getReportReasonValidationErrorDOM().innerHTML=M.GENERIC_ERROR}},{key:"onAjaxSuccess",value:function(t){var e=t.newFlags,r=t.formData,o=this.getFlagButtonDOM(),n=this.updateCurrentPostFlags(e,r)?P.REPORT_SENT:M.GENERIC_ERROR;n===P.REPORT_SENT&&this.swapFlagBtn(o,O({postType:r.postType,questionId:r.questionId,postId:r.postId,parentId:this.getPostParentId(r.postType,o)})),this.showFeedbackPopup(n)}},{key:"showFeedbackPopup",value:function(t){this.reportReasonPopupDOMReferences.reportReasonRequestInfo.innerHTML=t,this.reportReasonPopupDOMReferences.reportReasonPopup.classList.add("display-none"),this.reportReasonPopupDOMReferences.reportReasonRequestFeedback.classList.add("report-reason-popup","display-block"),this.reportReasonPopupDOMReferences.closeReportReasonRequestFeedback.focus()}},{key:"initSuccessPopupCloseBtn",value:function(){this.reportReasonPopupDOMReferences.closeReportReasonRequestFeedback.addEventListener("click",this.hideReportReasonPopup.bind(this))}}]),t}(),E=function(){var t=new p,e=new y,r=new D({getFlagButtonDOM:t.getFlagButtonDOM.bind(t),formInvalidityListenerAPI:e.formInvalidityListenerAPI,getFormDOM:e.getFormDOM.bind(e),getPostParentId:t.getPostParentId.bind(t),swapFlagBtn:t.swapFlagBtn.bind(t),updateCurrentPostFlags:t.updateCurrentPostFlags.bind(t),getReportReasonValidationErrorDOM:e.getReportReasonValidationErrorDOM.bind(e),resetCustomReportReasonCharCounter:e.resetCustomReportReasonCharCounter.bind(e)});return e.initButtons({collectForumPostMetaData:t.collectForumPostMetaData.bind(t),hideReportReasonPopup:r.hideReportReasonPopup.bind(r),onAjaxSuccess:r.onAjaxSuccess.bind(r),showFeedbackPopup:r.showFeedbackPopup.bind(r)}),t.onClick.bind(t,r.showReportReasonPopup.bind(r))}();document.querySelector(".qa-main").addEventListener("click",E,!0)}]);