!function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="../qa-plugin/report-reason/frontend/dist/",n(n.s=9)}([function(t,e,n){var r=n(4),o=n(5),a=n(6),s=n(8);t.exports=function(t,e){return r(t)||o(t,e)||a(t,e)||s()}},function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function n(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}t.exports=function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}},function(t,e){t.exports=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}},function(t,e){t.exports=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],r=!0,o=!1,a=void 0;try{for(var s,i=t[Symbol.iterator]();!(r=(s=i.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){o=!0,a=t}finally{try{r||null==i.return||i.return()}finally{if(o)throw a}}return n}}},function(t,e,n){var r=n(7);t.exports=function(t,e){if(t){if("string"==typeof t)return r(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,e):void 0}}},function(t,e){t.exports=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(t,e,n){"use strict";n.r(e);var r=n(0),o=n.n(r),a=n(1),s=n.n(a),i=n(2),u=n.n(i),p=function(){function t(){s()(this,t),this.flagButtonDOM=null,this.regex={question:/q_doflag/,answer:/^a(\d+)_doflag/,comment:/^c(\d+)_doflag/,doComment:/^a(\d+)_docomment/}}return u()(t,[{key:"onClick",value:function(t,e){e.target.name&&e.target.name.endsWith("doflag")&&(e.preventDefault(),e.stopPropagation(),this.flagButtonDOM=e.target,t())}},{key:"getPostIdFromInputName",value:function(t,e){var n=e.match(this.regex[t]);return o()(n,2)[1]}},{key:"recognizeInputKindByName",value:function(t){var e=Object.entries(this.regex).find((function(e){var n=o()(e,2);n[0];return n[1].test(t)}));return o()(e,1)[0]}},{key:"collectForumPostMetaData",value:function(){var t=this.recognizeInputKindByName(this.flagButtonDOM.name),e={questionId:this.flagButtonDOM.form.getAttribute("action").split("/")[1],postType:t.slice(0,1)};return e.postId=this.getPostIdFromInputName(t,this.flagButtonDOM.name)||e.questionId,e}},{key:"getFlagButtonDOM",value:function(){return this.flagButtonDOM}},{key:"getPostParentId",value:function(t,e){if("c"!==t)return null;var n=e.closest('[id*="_list"]');return n?n.id.match(/\d+/)[0]:null}},{key:"swapFlagBtn",value:function(t,e){var n=document.createElement("div");n.innerHTML=e;var r=n.removeChild(n.firstElementChild);t.parentNode.replaceChild(r,t)}},{key:"updateCurrentPostFlags",value:function(t,e){var n=this.prepareFlagsUpdate(t,e),r=n.flags,o=n.flagsAlreadyExist,a=n.flagsParent;return r?(o?a.parentNode.replaceChild(r,a):a.appendChild(r),!0):(console.error("Report reason response does not have new flags: ",t),!1)}},{key:"prepareFlagsUpdate",value:function(t,e){var n=e.postType,r=e.postId,o="q"===n?"view":"item",a=".qa-".concat(n,"-").concat(o,"-"),s="#".concat(n).concat(r," ").concat(a),i=document.querySelector("".concat(s,"flags"));return{flags:(new DOMParser).parseFromString(t,"text/html").querySelector("".concat(a,"flags")),flagsAlreadyExist:!!i,flagsParent:i||document.querySelector("".concat(s,"meta"))}}}]),t}(),c=n(3),l=n.n(c);var d=function(t){return new Promise((function(e,n){var r=setTimeout((function(){n("AJAX_TIMEOUT")}),5e3);fetch("/report-flag",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((function(t){return clearTimeout(r),t.ok||n(t.text()),t.json().then(e)})).catch(n)}))};function f(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function R(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?f(Object(n),!0).forEach((function(e){l()(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var h=FLAG_REASONS_METADATA,m=h.NOTICE_LENGTH,v=h.POPUP_LABELS,y=h.ERROR_CODES,g=function(){function t(){s()(this,t),this.buildForm(),this.initReportReasonValidationErrorDOM(),this.initReasonList(),this.initTextArea(),this.initFormInvalidityListenerAPI(),this.requestIntegerKeys=["postId","questionId","reasonId"],this.sendButton=null}return u()(t,[{key:"buildForm",value:function(){var t=document.createElement("form");t.method="post",t.classList.add("report-reason-popup__form"),t.innerHTML=this.getFormHTML(this.getReasonListHTML()),this.formDOM=t}},{key:"getReasonListHTML",value:function(){var t=this;return Object.entries(FLAG_REASONS_METADATA.REASON_LIST).reduce((function(e,n,r,a){var s=o()(n,2),i=s[0],u=s[1],p=r===a.length-1,c=p&&t.getTextAreaHTML();return e+t.getListItemsHTML({reasonKey:i,reasonValue:u,index:r,isLast:p,textAreaDOM:c})}),"")}},{key:"initReasonList",value:function(){var t=this,e=this.formDOM.querySelector("#reportReasonList");e.addEventListener("change",(function(n){var r=n.target;t.reportReasonValidationErrorDOM.classList.remove("display-block");var o=e.children[e.children.length-1].contains(r);t.formDOM.elements.customReportReason.parentNode.classList.toggle("display-none",!o),t.formDOM.elements.customReportReason.required=o,t.formDOM.elements.sendReportReason.disabled=!1,o&&t.formDOM.elements.customReportReason.focus()}))}},{key:"initReportReasonValidationErrorDOM",value:function(){this.reportReasonValidationErrorDOM=this.formDOM.querySelector("#reportReasonValidationError")}},{key:"initTextArea",value:function(){var t=this;this.customReportReasonCharCounter=this.formDOM.querySelector("#customReportReasonCharCounter"),this.formDOM.elements.customReportReason.addEventListener("input",(function(e){var n=e.target;t.formDOM.elements.sendReportReason.disabled=!1,t.reportReasonValidationErrorDOM.classList.remove("display-block"),t.customReportReasonCharCounter.textContent=m-n.value.length}))}},{key:"initFormInvalidityListenerAPI",value:function(){var t=this;this.formInvalidityListenerAPI={_handler:function(t){t.preventDefault()},attach:function(){t.formDOM.addEventListener("invalid",t.formInvalidityListenerAPI._handler,!0)},detach:function(){t.formDOM.removeEventListener("invalid",t.formInvalidityListenerAPI._handler,!0)}}}},{key:"resetCustomReportReasonCharCounter",value:function(){this.customReportReasonCharCounter.textContent=m}},{key:"getTextAreaHTML",value:function(){return'\n\t\t\t<div id="customReportReasonWrapper" class="report-reason-popup__custom-report-reason-wrapper display-none">\n\t\t\t\t<small class="report-reason-popup__custom-report-reason-char-counter-wrapper">\n\t\t\t\t\t'.concat(v.CHAR_COUNTER_INFO,'\n\t\t\t\t\t<output id="customReportReasonCharCounter">').concat(m,'</output>\n\t\t\t\t</small>\n\t\t\t\t<textarea id="customReportReason"\n\t\t\t\t\tclass="report-reason-popup__custom-report-reason"\n\t\t\t\t\tname="reportReason"\n\t\t\t\t\tmaxlength="').concat(m,'"\n\t\t\t\t\trows="3"\n\t\t\t\t\tcols="47"></textarea>\n\t\t\t</div>')}},{key:"getListItemsHTML",value:function(t){var e=t.reasonKey,n=t.reasonValue,r=t.index,o=t.isLast,a=t.textAreaDOM;return'\n\t\t\t<li>\n\t\t\t\t<label for="'.concat(e,'">\n\t\t\t\t\t<input id="').concat(e,'" \n\t\t\t\t\t\t\ttype="radio" \n\t\t\t\t\t\t\tvalue="').concat(r,'" \n\t\t\t\t\t\t\tname="reportReason"\n\t\t\t\t\t\t\trequired>\n\t\t\t\t\t').concat(n,"\n\t\t\t\t</label>\n\t\t\t\t").concat(o?a:"","\n\t\t\t</li>")}},{key:"getFormHTML",value:function(t){return"\n\t\t\t<fieldset>\n\t\t\t\t<legend>".concat(v.HEADER,'</legend>\n\t\t\t\t<ul id="reportReasonList" class="report-reason-popup__list">').concat(t,'</ul>\n\t\n\t\t\t\t<span id="reportReasonValidationError" class="report-reason-popup__validation-error">').concat(y.GENERIC_ERROR,'</span>\n\t\n\t\t\t\t<div class="report-reason-popup-buttons">\n\t\t\t\t\t<button id="cancelReportReason"\n\t\t\t\t\t\ttype="button"\n\t\t\t\t\t\tclass="report-reason-popup__button report-reason-popup__button--cancel">').concat(v.CANCEL,'</button>\n\t\t\t\t\t<button id="sendReportReason"\n\t\t\t\t\t\ttype="submit"\n\t\t\t\t\t\tclass="report-reason-popup__button report-reason-popup__button--save">').concat(v.SEND,"</button>\n\t\t\t\t</div>\n\t\t\t</fieldset>")}},{key:"getFormDOM",value:function(){return this.formDOM}},{key:"getReportReasonValidationErrorDOM",value:function(){return this.reportReasonValidationErrorDOM}},{key:"initButtons",value:function(t){var e=this,n=t.collectForumPostMetaData,r=t.hideReportReasonPopup,o=t.onAjaxSuccess,a=t.showFeedbackPopup;this.formDOM.elements.cancelReportReason.addEventListener("click",r),this.formDOM.elements.sendReportReason.addEventListener("click",(function(t){e.handleReportResult(e.submitForm(t,n()),o,a)}))}},{key:"prepareFormData",value:function(t){var e=new FormData(this.formDOM).getAll("reportReason"),n=o()(e,2),r=n[0],a=n[1];return R(R({},t),{},{reasonId:r,notice:a,reportType:"addFlag"})}},{key:"normalizeIntegerProps",value:function(t){var e=this;return Object.entries(t).reduce((function(t,n){var r=o()(n,2),a=r[0],s=r[1];return e.requestIntegerKeys.includes(a)&&(t[a]=parseInt(s)),t}),t)}},{key:"submitForm",value:function(t,e){t.preventDefault(),this.sendButton=t.target,this.sendButton.disabled=!0;var n=this.validateForm();if(n)return Promise.reject({formValidationErrorCode:n});var r=this.prepareFormData(e);return this.toggleSendWaitingState(this.sendButton,!0),d(this.normalizeIntegerProps(r)).then((function(t){return R(R({},t),{},{formData:r})}))}},{key:"handleReportResult",value:function(t,e,n){var r=this;t.then((function(t){if(!t.newFlags)return Promise.reject(t);r.sendButton.disabled=!1,e(t)})).catch((function(t){t.formValidationErrorCode?r.handleReportReasonError(t):r.handleReportReasonError(t,n)})).finally((function(){r.toggleSendWaitingState(r.sendButton,!1)}))}},{key:"handleReportReasonError",value:function(t,e){var n=t.formValidationErrorCode||t.processingFlagReasonError||t,r=this.getErrorContent(n);"function"==typeof e?e(r):this.onFormSubmissionError(r),console.error("Report reason rejected: ",t," /errorContent: ",r)}},{key:"validateForm",value:function(){return this.formDOM.reportValidity()?"":this.formDOM.elements.customReportReason.validity.valid?"NO_REASON_CHECKED":"CUSTOM_REASON_EMPTY"}},{key:"getErrorContent",value:function(t){if(t.includes(" "))return t;if(!t||t instanceof Error)return y.GENERIC_ERROR;if(t.includes(":")){var e=t.split(":"),n=o()(e,2),r=n[0],a=n[1];return y[r]?y[r]+a:y.GENERIC_ERROR}return y[t]}},{key:"onFormSubmissionError",value:function(t){var e=this;this.reportReasonValidationErrorDOM.innerHTML=t,this.reportReasonValidationErrorDOM.classList.add("display-block","report-reason-popup__validation-error--blink"),setTimeout((function(){e.reportReasonValidationErrorDOM.classList.remove("report-reason-popup__validation-error--blink")}),1750)}},{key:"toggleSendWaitingState",value:function(t,e){e?window.qa_show_waiting_after(t,!0):window.qa_hide_waiting(t)}}]),t}();var O=function(t){var e=t.postType,n=t.questionId,r=t.postId,o=t.parentId,a=e+r,s="";switch(e){case"q":s="qa_show_waiting_after(this, false)",a=e;break;case"a":s="return qa_answer_click(".concat(r,", ").concat(n,", this);");break;case"c":s="return qa_comment_click(".concat(r,", ").concat(n,", ").concat(o,", this);");break;default:throw new Error("Unrecognized postType: ".concat(e," for questionId: ").concat(n," and postId: ").concat(r))}return'\n\t\t<input name="'.concat(a).concat("_dounflag",'" \n\t\t\tonclick="').concat(s,'"\n\t\t\tvalue="').concat("wycofaj zgłoszenie",'"\n\t\t\ttitle="').concat("Wycofaj zgłoszenie tej treści",'"\n\t\t\ttype="').concat("submit",'" \n\t\t\tclass="').concat("qa-form-light-button qa-form-light-button-unflag",'">\n\t')},b=FLAG_REASONS_METADATA,P=b.POPUP_LABELS,M=b.ERROR_CODES,D=function(){function t(e){var n=e.getFlagButtonDOM,r=e.formInvalidityListenerAPI,o=e.getFormDOM,a=e.getPostParentId,i=e.swapFlagBtn,u=e.updateCurrentPostFlags,p=e.getReportReasonValidationErrorDOM,c=e.resetCustomReportReasonCharCounter;s()(this,t),this.getFlagButtonDOM=n,this.formInvalidityListenerAPI=r,this.getFormDOM=o,this.getPostParentId=a,this.swapFlagBtn=i,this.updateCurrentPostFlags=u,this.getReportReasonValidationErrorDOM=p,this.resetCustomReportReasonCharCounter=c,this.reportReasonPopupDOMWrapper=null,this.reportReasonPopupDOMReferences=null,this.initReportReasonPopupDOMWrapper(),this.initPopupContainer(),this.initPopupDOMReferences(),this.initOffClickHandler(),this.initSuccessPopupCloseBtn()}return u()(t,[{key:"initOffClickHandler",value:function(){var t=this;this.reportReasonPopupDOMWrapper.addEventListener("click",(function(e){!e.composedPath().some((function(t){return"reportReasonPopup"===t.id||"reportReasonRequestFeedback"===t.id}))&&t.hideReportReasonPopup()}))}},{key:"initPopupContainer",value:function(){document.querySelector(".qa-body-wrapper").appendChild(this.reportReasonPopupDOMWrapper)}},{key:"initReportReasonPopupDOMWrapper",value:function(){var t=document.createElement("div");t.classList.add("report-reason-wrapper","display-none"),t.innerHTML=this.getPopupWrapperHTML();var e=t.querySelector("#replaceableForm");e.parentNode.replaceChild(this.getFormDOM(),e),this.reportReasonPopupDOMWrapper=t}},{key:"initPopupDOMReferences",value:function(){this.reportReasonPopupDOMReferences={reportReasonPopup:this.reportReasonPopupDOMWrapper.querySelector("#reportReasonPopup"),customReportReason:this.reportReasonPopupDOMWrapper.querySelector("#customReportReason"),reportReasonRequestFeedback:this.reportReasonPopupDOMWrapper.querySelector("#reportReasonRequestFeedback"),reportReasonRequestInfo:this.reportReasonPopupDOMWrapper.querySelector("#reportReasonRequestInfo"),closeReportReasonRequestFeedback:this.reportReasonPopupDOMWrapper.querySelector("#closeReportReasonRequestFeedback")}}},{key:"getPopupWrapperHTML",value:function(){return'\n\t\t\t<div id="reportReasonPopup" class="report-reason-popup">\n\t\t\t\t<form id="replaceableForm"></form>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div id="reportReasonRequestFeedback" class="report-reason-popup report-reason-popup__request-feedback display-none">\n\t\t\t\t<div id="reportReasonRequestInfo" class="report-reason-popup__request-feedback-info"></div>\n\t\t\t\t<button id="closeReportReasonRequestFeedback"\n\t\t\t\t\tclass="report-reason-popup__button report-reason-popup__button--close"\n\t\t\t\t\ttype="button">'.concat(P.CLOSE,"</button>\n\t\t\t</div>\n\t\t")}},{key:"showReportReasonPopup",value:function(){this.formInvalidityListenerAPI.attach(),this.reportReasonPopupDOMWrapper.classList.remove("display-none"),this.reportReasonPopupDOMReferences.reportReasonPopup.classList.remove("display-none"),this.getFormDOM().elements.reportReason[0].focus()}},{key:"hideReportReasonPopup",value:function(){this.formInvalidityListenerAPI.detach(),this.reportReasonPopupDOMReferences.reportReasonRequestFeedback.classList.add("display-none"),this.reportReasonPopupDOMWrapper.classList.add("display-none"),this.reportReasonPopupDOMReferences.customReportReason.parentNode.classList.add("display-none"),this.getReportReasonValidationErrorDOM().classList.remove("display-block");var t=this.getFormDOM();t.reset(),t.elements.customReportReason.required=!1,t.elements.sendReportReason.disabled=!1,this.resetCustomReportReasonCharCounter(),this.getReportReasonValidationErrorDOM().innerHTML=M.GENERIC_ERROR}},{key:"onAjaxSuccess",value:function(t){var e=t.newFlags,n=t.formData,r=this.getFlagButtonDOM(),o=this.updateCurrentPostFlags(e,n)?P.REPORT_SENT:M.GENERIC_ERROR;o===P.REPORT_SENT&&this.swapFlagBtn(r,O({postType:n.postType,questionId:n.questionId,postId:n.postId,parentId:this.getPostParentId(n.postType,r)})),this.showFeedbackPopup(o)}},{key:"showFeedbackPopup",value:function(t){this.reportReasonPopupDOMReferences.reportReasonRequestInfo.innerHTML=t,this.reportReasonPopupDOMReferences.reportReasonPopup.classList.add("display-none"),this.reportReasonPopupDOMReferences.reportReasonRequestFeedback.classList.remove("display-none"),this.reportReasonPopupDOMReferences.closeReportReasonRequestFeedback.focus()}},{key:"initSuccessPopupCloseBtn",value:function(){this.reportReasonPopupDOMReferences.closeReportReasonRequestFeedback.addEventListener("click",this.hideReportReasonPopup.bind(this))}}]),t}(),E=function(){var t=new p,e=new g,n=new D({getFlagButtonDOM:t.getFlagButtonDOM.bind(t),formInvalidityListenerAPI:e.formInvalidityListenerAPI,getFormDOM:e.getFormDOM.bind(e),getPostParentId:t.getPostParentId.bind(t),swapFlagBtn:t.swapFlagBtn.bind(t),updateCurrentPostFlags:t.updateCurrentPostFlags.bind(t),getReportReasonValidationErrorDOM:e.getReportReasonValidationErrorDOM.bind(e),resetCustomReportReasonCharCounter:e.resetCustomReportReasonCharCounter.bind(e)});return e.initButtons({collectForumPostMetaData:t.collectForumPostMetaData.bind(t),hideReportReasonPopup:n.hideReportReasonPopup.bind(n),onAjaxSuccess:n.onAjaxSuccess.bind(n),showFeedbackPopup:n.showFeedbackPopup.bind(n)}),t.onClick.bind(t,n.showReportReasonPopup.bind(n))}();document.querySelector(".qa-main").addEventListener("click",E,!0)}]);